<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PUA Meeting Room v0.6.0 - èŒåœºä¼šè®®å®¤æ¨¡æ‹Ÿå™¨</title>
  <meta name="description" content="PUA Meeting Room - å¤šè§’è‰²èŒåœºä¼šè®®æ¨¡æ‹Ÿï¼Œé€‰æ‹©å‚ä¼šè€…å¼€å§‹ä¸€åœºå……æ»¡èŒåœºPUAçš„ä¼šè®®">
  <meta property="og:title" content="PUA Meeting Room - èŒåœºä¼šè®®å®¤">
  <meta property="og:description" content="å¤šè§’è‰²åŒæ—¶å‚ä¼šçš„èŒåœºä¼šè®®æ¨¡æ‹Ÿå™¨ï¼Œ6ç§è§’è‰²éšæœºæ­è¯ï¼Œä½“éªŒçœŸå®ä¼šè®®è®¨è®º">
  <meta property="og:type" content="website">
  <meta name="theme-color" content="#0a0a0a">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¢</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'JetBrains Mono', 'Consolas', monospace;
      background: #0a0a0a;
      min-height: 100vh;
      overflow-x: hidden;
      color: #e0e0e0;
    }

    /* === Terminal Shell === */
    .terminal {
      width: 94%;
      max-width: 960px;
      margin: 20px auto;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
      overflow: hidden;
    }

    .terminal-header {
      padding: 10px 16px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #333;
    }

    .terminal-buttons { display: flex; gap: 8px; }
    .terminal-btn { width: 12px; height: 12px; border-radius: 50%; }
    .terminal-btn.close { background: #ff5f56; }
    .terminal-btn.minimize { background: #ffbd2e; }
    .terminal-btn.maximize { background: #27ca3f; }
    .terminal-title { color: #888; font-size: 12px; flex: 1; text-align: center; }

    /* === Views === */
    .view { display: none; flex-direction: column; flex: 1; min-height: 0; }
    .view.active { display: flex; }

    /* === SETUP VIEW === */
    #setupView { padding: 24px; overflow-y: auto; }
    #setupView h2 { color: #00ff00; font-size: 18px; margin-bottom: 6px; }
    .setup-subtitle { color: #666; font-size: 12px; margin-bottom: 24px; }

    .section-label { color: #888; font-size: 13px; margin-bottom: 10px; display: block; }

    /* Character Grid */
    .char-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .char-card {
      background: #111;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .char-card:hover { border-color: #555; transform: translateY(-2px); }
    .char-card.selected { border-color: var(--role-color, #00ff00); background: #1a1a1a; }

    .char-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      transition: box-shadow 0.3s;
    }

    .char-card.selected .char-avatar {
      box-shadow: 0 0 20px var(--role-glow, rgba(0,255,0,0.4));
    }

    .char-name { color: #fff; font-size: 14px; font-weight: 700; }
    .char-title { color: #888; font-size: 11px; margin-top: 2px; }
    .char-tag { color: #555; font-size: 10px; margin-top: 4px; font-style: italic; }

    /* Avatar color variants */
    .avatar-boss { background: linear-gradient(135deg, #ff4444, #cc0000); }
    .avatar-employee { background: linear-gradient(135deg, #ffcc00, #cc9900); }
    .avatar-pm { background: linear-gradient(135deg, #00cccc, #008888); }
    .avatar-hr { background: linear-gradient(135deg, #cc44ff, #8800aa); }
    .avatar-techlead { background: linear-gradient(135deg, #4488ff, #0044cc); }
    .avatar-intern { background: linear-gradient(135deg, #44ff44, #00aa00); }

    /* Meeting type & chaos */
    .option-row {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .option-group { flex: 1; min-width: 200px; }
    .option-group label { color: #888; font-size: 12px; display: block; margin-bottom: 6px; }
    .option-group select, .option-group input[type="range"] {
      width: 100%;
      background: #111;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px 10px;
      font-family: inherit;
      font-size: 13px;
    }
    .option-group select:focus { outline: none; border-color: #00ff00; }

    .chaos-display {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .chaos-value { color: #00ff00; font-weight: 700; font-size: 13px; text-align: center; margin-top: 4px; }

    /* Start button */
    .start-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #00aa00, #008800);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .start-btn:hover { background: linear-gradient(135deg, #00cc00, #00aa00); transform: translateY(-1px); }
    .start-btn:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }
    .start-btn-hint { color: #555; font-size: 11px; text-align: center; margin-top: 8px; }

    /* === MEETING VIEW === */
    /* Top participants bar */
    .participants-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: #111;
      border-bottom: 1px solid #222;
      overflow-x: auto;
    }

    .participant-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: #1a1a1a;
      border-radius: 16px;
      border: 1px solid #333;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .participant-mini-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      transition: box-shadow 0.5s;
    }

    .participant-chip-name { font-size: 11px; color: #aaa; }

    /* Mood glow animation */
    @keyframes moodPulse {
      0%, 100% { box-shadow: 0 0 8px var(--glow-color, transparent); }
      50% { box-shadow: 0 0 16px var(--glow-color, transparent); }
    }

    .participant-mini-avatar[data-mood="angry"] { --glow-color: rgba(255,0,0,0.6); animation: moodPulse 1.5s infinite; }
    .participant-mini-avatar[data-mood="smug"] { --glow-color: rgba(255,215,0,0.6); animation: moodPulse 1.5s infinite; }
    .participant-mini-avatar[data-mood="worried"] { --glow-color: rgba(255,165,0,0.5); animation: moodPulse 1.5s infinite; }
    .participant-mini-avatar[data-mood="submissive"] { --glow-color: rgba(100,100,255,0.4); animation: moodPulse 1.5s infinite; }
    .participant-mini-avatar[data-mood="excited"] { --glow-color: rgba(0,255,100,0.5); animation: moodPulse 1.5s infinite; }

    /* Chat area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scroll-behavior: smooth;
      min-height: 0;
    }

    .chat-msg {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      animation: fadeSlideIn 0.4s ease-out;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .msg-body { flex: 1; }
    .msg-name { font-size: 12px; font-weight: 700; margin-bottom: 3px; }
    .msg-content { font-size: 13px; color: #ccc; line-height: 1.5; }

    /* User message */
    .chat-msg.user-msg .msg-avatar { background: linear-gradient(135deg, #333, #555); }
    .chat-msg.user-msg .msg-name { color: #00ff00; }

    /* Role colors for names */
    .name-boss { color: #ff4444; }
    .name-employee { color: #ffcc00; }
    .name-pm { color: #00cccc; }
    .name-hr { color: #cc44ff; }
    .name-techlead { color: #4488ff; }
    .name-intern { color: #44ff44; }

    /* Meeting event */
    .meeting-event {
      text-align: center;
      padding: 8px 16px;
      margin: 10px 0;
      color: #888;
      font-size: 12px;
      font-style: italic;
      background: #111;
      border-radius: 8px;
      border: 1px dashed #333;
      animation: fadeSlideIn 0.4s ease-out;
    }

    /* Gold quote */
    .gold-quote {
      border-left: 3px solid #ffd700;
      padding-left: 10px;
    }

    .gold-quote .msg-content::before {
      content: 'ğŸ’ ';
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      align-items: center;
      animation: fadeSlideIn 0.3s ease-out;
    }

    .typing-dots { display: flex; gap: 4px; }
    .typing-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #555;
      animation: typingBounce 1.2s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    .typing-name { font-size: 11px; color: #666; }

    /* Score card overlay */
    .score-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .score-overlay.active { display: flex; }

    .score-card {
      background: #111;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 24px;
      max-width: 420px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .score-card h3 { color: #ffd700; font-size: 16px; margin-bottom: 16px; text-align: center; }

    .score-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #222;
      font-size: 13px;
    }
    .score-label { color: #888; }
    .score-value { color: #00ff00; font-weight: 700; }

    .score-stars { text-align: center; font-size: 24px; margin: 12px 0; }
    .score-summary { text-align: center; color: #888; font-size: 13px; font-style: italic; margin: 8px 0; }
    .score-gold { color: #ffd700; font-size: 12px; margin-top: 12px; padding: 8px; background: #1a1a1a; border-radius: 6px; }

    .score-close {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 16px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      cursor: pointer;
    }

    /* Input area */
    .input-area {
      padding: 12px 16px;
      border-top: 1px solid #222;
      background: #0d0d0d;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .input-area textarea {
      flex: 1;
      background: #111;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 13px;
      resize: none;
      min-height: 40px;
      max-height: 100px;
    }
    .input-area textarea:focus { outline: none; border-color: #00ff00; }
    .input-area textarea::placeholder { color: #555; }

    .send-btn {
      padding: 10px 18px;
      background: #00aa00;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    .send-btn:hover { background: #00cc00; }
    .send-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

    /* Status bar */
    .status-bar {
      padding: 6px 16px;
      background: #111;
      border-top: 1px solid #222;
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #555;
    }

    .status-bar a { color: #00aa00; text-decoration: none; }
    .status-bar a:hover { text-decoration: underline; }

    /* Responsive */
    @media (max-width: 600px) {
      .terminal { width: 100%; margin: 0; height: 100vh; border-radius: 0; border: none; }
      .char-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      #setupView { padding: 16px; }
      .char-avatar { width: 48px; height: 48px; font-size: 22px; }
    }
  </style>
</head>
<body>

<div class="terminal">
  <div class="terminal-header">
    <div class="terminal-buttons">
      <span class="terminal-btn close"></span>
      <span class="terminal-btn minimize"></span>
      <span class="terminal-btn maximize"></span>
    </div>
    <div class="terminal-title">PUA Meeting Room v0.6.0</div>
  </div>

  <!-- ====== SETUP VIEW ====== -->
  <div id="setupView" class="view active">
    <h2>ğŸ¢ èŒåœºä¼šè®®å®¤</h2>
    <div class="setup-subtitle">é€‰æ‹©å‚ä¼šè§’è‰²ï¼Œå¼€å§‹ä¸€åœºå……æ»¡PUAçš„ä¼šè®®</div>

    <span class="section-label">é€‰æ‹©å‚ä¼šè€…ï¼ˆ2-6äººï¼‰</span>
    <div class="char-grid" id="charGrid">
      <div class="char-card" data-role="boss" style="--role-color:#ff4444;--role-glow:rgba(255,68,68,0.4)" onclick="toggleChar(this)">
        <div class="char-avatar avatar-boss">ğŸ‘”</div>
        <div class="char-name">å¼ æ€»</div>
        <div class="char-title">è€æ¿</div>
        <div class="char-tag">ç”»é¥¼å¤§å¸ˆ / PUAä¸“å®¶</div>
      </div>
      <div class="char-card" data-role="employee" style="--role-color:#ffcc00;--role-glow:rgba(255,204,0,0.4)" onclick="toggleChar(this)">
        <div class="char-avatar avatar-employee">ğŸ˜“</div>
        <div class="char-name">å°ç‹</div>
        <div class="char-title">å‘˜å·¥</div>
        <div class="char-tag">æ‰“å·¥äºº / å‘å¾®æ±‚ç”Ÿ</div>
      </div>
      <div class="char-card" data-role="pm" style="--role-color:#00cccc;--role-glow:rgba(0,204,204,0.4)" onclick="toggleChar(this)">
        <div class="char-avatar avatar-pm">ğŸ“‹</div>
        <div class="char-name">æå§</div>
        <div class="char-title">äº§å“ç»ç†</div>
        <div class="char-tag">éœ€æ±‚å˜æ›´ä¸“å®¶</div>
      </div>
      <div class="char-card" data-role="hr" style="--role-color:#cc44ff;--role-glow:rgba(204,68,255,0.4)" onclick="toggleChar(this)">
        <div class="char-avatar avatar-hr">ğŸ’¼</div>
        <div class="char-name">é™ˆå§</div>
        <div class="char-title">HR</div>
        <div class="char-tag">å…¬å¸å°±æ˜¯å®¶</div>
      </div>
      <div class="char-card" data-role="techlead" style="--role-color:#4488ff;--role-glow:rgba(68,136,255,0.4)" onclick="toggleChar(this)">
        <div class="char-avatar avatar-techlead">ğŸ’»</div>
        <div class="char-name">åˆ˜å“¥</div>
        <div class="char-title">æŠ€æœ¯ä¸»ç®¡</div>
        <div class="char-tag">é‡æ„ç‹‚äºº</div>
      </div>
      <div class="char-card" data-role="intern" style="--role-color:#44ff44;--role-glow:rgba(68,255,68,0.4)" onclick="toggleChar(this)">
        <div class="char-avatar avatar-intern">ğŸŒ±</div>
        <div class="char-name">å°èµµ</div>
        <div class="char-title">å®ä¹ ç”Ÿ</div>
        <div class="char-tag">å‘å¾®æ±‚å­¦è€…</div>
      </div>
    </div>

    <div class="option-row">
      <div class="option-group">
        <label>ä¼šè®®ç±»å‹</label>
        <select id="meetingType">
          <option value="standup">ğŸ“‹ æ¯æ—¥ç«™ä¼š</option>
          <option value="brainstorm">ğŸ’¡ å¤´è„‘é£æš´</option>
          <option value="review">ğŸ” è¯„å®¡ä¼šè®®</option>
          <option value="retro">ğŸ”„ å›é¡¾ä¼šè®®</option>
          <option value="planning">ğŸ“… è§„åˆ’ä¼šè®®</option>
          <option value="emergency" selected>ğŸš¨ ç´§æ€¥ä¼šè®®</option>
        </select>
      </div>
      <div class="option-group">
        <label>æ··ä¹±ç¨‹åº¦</label>
        <input type="range" id="chaosLevel" min="1" max="3" value="2" oninput="updateChaosDisplay()">
        <div class="chaos-display">
          <span>æœ‰åº</span>
          <span>æ ‡å‡†</span>
          <span>æ··ä¹±</span>
        </div>
        <div class="chaos-value" id="chaosValue">ğŸ”¥ æ ‡å‡†</div>
      </div>
    </div>

    <button class="start-btn" id="startBtn" onclick="startMeeting()" disabled>
      ğŸš€ å¼€å§‹ä¼šè®®
    </button>
    <div class="start-btn-hint" id="startHint">è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªå‚ä¼šè§’è‰²</div>
  </div>

  <!-- ====== MEETING VIEW ====== -->
  <div id="meetingView" class="view">
    <div class="participants-bar" id="participantsBar"></div>

    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
      <textarea id="msgInput" placeholder="åœ¨ä¼šè®®ä¸­å‘è¨€..." rows="1"
        onkeydown="handleMeetingKeydown(event)"></textarea>
      <button class="send-btn" id="meetingSendBtn" onclick="sendMeetingMessage()">å‘é€</button>
    </div>

    <div class="status-bar">
      <span id="meetingInfo">--</span>
      <span>
        <a href="#" onclick="showScoreCard(); return false;">/score</a> |
        <a href="/index.html">1v1 å¯¹è¯</a> |
        <a href="https://github.com/ava-agent/pua-cli" target="_blank">GitHub</a>
      </span>
    </div>
  </div>
</div>

<!-- Score Card Overlay -->
<div class="score-overlay" id="scoreOverlay">
  <div class="score-card" id="scoreCardContent"></div>
</div>

<script>
// ==================== STATE ====================
const state = {
  selectedRoles: [],
  meetingType: 'emergency',
  chaosLevel: 2,
  messages: [],       // { role, name, content, mood }
  history: [],        // for API context
  lastRespondents: [],
  isSending: false,
  messageCount: 0,
};

const CHAR_INFO = {
  boss:     { name: 'å¼ æ€»', title: 'è€æ¿',   emoji: 'ğŸ‘”', avatarClass: 'avatar-boss',     nameClass: 'name-boss' },
  employee: { name: 'å°ç‹', title: 'å‘˜å·¥',   emoji: 'ğŸ˜“', avatarClass: 'avatar-employee', nameClass: 'name-employee' },
  pm:       { name: 'æå§', title: 'äº§å“ç»ç†', emoji: 'ğŸ“‹', avatarClass: 'avatar-pm',       nameClass: 'name-pm' },
  hr:       { name: 'é™ˆå§', title: 'HR',     emoji: 'ğŸ’¼', avatarClass: 'avatar-hr',       nameClass: 'name-hr' },
  techlead: { name: 'åˆ˜å“¥', title: 'æŠ€æœ¯ä¸»ç®¡', emoji: 'ğŸ’»', avatarClass: 'avatar-techlead', nameClass: 'name-techlead' },
  intern:   { name: 'å°èµµ', title: 'å®ä¹ ç”Ÿ',  emoji: 'ğŸŒ±', avatarClass: 'avatar-intern',   nameClass: 'name-intern' },
};

const MEETING_EVENTS = [
  { text: 'ğŸ“± å¼ æ€»çš„æ‰‹æœºå“äº†ï¼Œä»–å‡ºå»æ¥ç”µè¯äº†...', role: 'boss' },
  { text: 'â˜• å°èµµæ‰“ç¿»äº†å’–å•¡ï¼"å¯¹ä¸èµ·å¯¹ä¸èµ·ï¼"', role: 'intern' },
  { text: 'ğŸ¦— ...å°´å°¬çš„æ²‰é»˜...å¤§å®¶äº’ç›¸çœ‹ç€...' },
  { text: 'ğŸ’¥ æå§çªç„¶è¯´ï¼š"ç­‰ç­‰ï¼Œéœ€æ±‚å˜äº†"', role: 'pm' },
  { text: 'ğŸ“¢ å¼ æ€»å¼€å§‹å³å…´æ¼”è®²ï¼š"æƒ³å½“å¹´æˆ‘åˆ›ä¸šçš„æ—¶å€™..."', role: 'boss' },
  { text: 'ğŸ’¤ å°ç‹å·®ç‚¹ç¡ç€äº†...', role: 'employee' },
  { text: 'ğŸ“ å°èµµç–¯ç‹‚è®°ç¬”è®°ä¸­...', role: 'intern' },
  { text: 'ğŸ”¥ åˆ˜å“¥å’Œæå§åµèµ·æ¥äº†ï¼', role: 'techlead' },
  { text: 'ğŸ‚ é™ˆå§çªç„¶æè®®ï¼š"è¦ä¸è¦å›¢å»ºï¼Ÿ"', role: 'hr' },
  { text: 'ğŸ’» åˆ˜å“¥æ‰“å¼€äº†IDEå¼€å§‹å†™ä»£ç ...', role: 'techlead' },
  { text: 'ğŸœ æœ‰äººçš„å¤–å–åˆ°äº†ï¼Œæ•´ä¸ªä¼šè®®å®¤éƒ½æ˜¯å‘³é“...' },
  { text: 'ğŸ“Š æå§æå‡ºäº†ä¸€ä¸ª40é¡µçš„PPT...', role: 'pm' },
  { text: 'ğŸ¤ é™ˆå§å‘èµ·å¤§å®¶ä¸€èµ·å–Šå£å·ï¼š"åŠ æ²¹ï¼å¥‹æ–—ï¼"', role: 'hr' },
  { text: 'â° å·²ç»è¶…æ—¶äº†ï¼Œä½†å¼ æ€»è¿˜åœ¨è¯´...', role: 'boss' },
];

// ==================== SETUP ====================
function toggleChar(card) {
  const role = card.dataset.role;
  card.classList.toggle('selected');

  if (card.classList.contains('selected')) {
    if (!state.selectedRoles.includes(role)) state.selectedRoles.push(role);
  } else {
    state.selectedRoles = state.selectedRoles.filter(r => r !== role);
  }

  updateStartButton();
}

function updateStartButton() {
  const btn = document.getElementById('startBtn');
  const hint = document.getElementById('startHint');
  const count = state.selectedRoles.length;

  if (count >= 2) {
    btn.disabled = false;
    hint.textContent = `å·²é€‰ ${count} äººå‚ä¼šï¼Œå‡†å¤‡å¼€ä¼šï¼`;
  } else {
    btn.disabled = true;
    hint.textContent = `è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªå‚ä¼šè§’è‰²ï¼ˆå·²é€‰ ${count} äººï¼‰`;
  }
}

function updateChaosDisplay() {
  const val = parseInt(document.getElementById('chaosLevel').value);
  state.chaosLevel = val;
  const labels = { 1: 'ğŸ§Š æœ‰åº', 2: 'ğŸ”¥ æ ‡å‡†', 3: 'ğŸ’¥ æ··ä¹±' };
  document.getElementById('chaosValue').textContent = labels[val];
}

// ==================== START MEETING ====================
function startMeeting() {
  state.meetingType = document.getElementById('meetingType').value;
  state.chaosLevel = parseInt(document.getElementById('chaosLevel').value);

  // Switch view
  document.getElementById('setupView').classList.remove('active');
  document.getElementById('meetingView').classList.add('active');

  // Build participants bar
  buildParticipantsBar();

  // Update status info
  const typeNames = {
    standup: 'æ¯æ—¥ç«™ä¼š', brainstorm: 'å¤´è„‘é£æš´', review: 'è¯„å®¡ä¼šè®®',
    retro: 'å›é¡¾ä¼šè®®', planning: 'è§„åˆ’ä¼šè®®', emergency: 'ç´§æ€¥ä¼šè®®',
  };
  const chaosLabels = { 1: 'æœ‰åº', 2: 'æ ‡å‡†', 3: 'æ··ä¹±' };
  document.getElementById('meetingInfo').textContent =
    `${typeNames[state.meetingType]} | æ··ä¹±: ${chaosLabels[state.chaosLevel]} | ${state.selectedRoles.length}äººå‚ä¼š`;

  // Welcome message
  addSystemMessage(`ğŸ¢ ${typeNames[state.meetingType]}å¼€å§‹äº†ï¼å‚ä¼šäººå‘˜ï¼š${state.selectedRoles.map(r => CHAR_INFO[r].name).join('ã€')}å’Œä½ ã€‚`);

  // Focus input
  document.getElementById('msgInput').focus();
}

function buildParticipantsBar() {
  const bar = document.getElementById('participantsBar');
  bar.innerHTML = '';

  // Add user chip
  const userChip = document.createElement('div');
  userChip.className = 'participant-chip';
  userChip.innerHTML = `
    <div class="participant-mini-avatar" style="background:linear-gradient(135deg,#333,#555)">ğŸ‘¤</div>
    <span class="participant-chip-name" style="color:#00ff00">ä½ </span>
  `;
  bar.appendChild(userChip);

  // Add role chips
  for (const role of state.selectedRoles) {
    const info = CHAR_INFO[role];
    const chip = document.createElement('div');
    chip.className = 'participant-chip';
    chip.id = `chip-${role}`;
    chip.innerHTML = `
      <div class="participant-mini-avatar ${info.avatarClass}" id="avatar-${role}">${info.emoji}</div>
      <span class="participant-chip-name">${info.name}</span>
    `;
    bar.appendChild(chip);
  }
}

// ==================== CHAT ====================
function addSystemMessage(text) {
  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'meeting-event';
  div.textContent = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function addUserMessage(text) {
  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'chat-msg user-msg';
  div.innerHTML = `
    <div class="msg-avatar" style="background:linear-gradient(135deg,#333,#555)">ğŸ‘¤</div>
    <div class="msg-body">
      <div class="msg-name" style="color:#00ff00">ä½ </div>
      <div class="msg-content">${escapeHtml(text)}</div>
    </div>
  `;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function addRoleMessage(role, name, content, mood, isGold) {
  const info = CHAR_INFO[role];
  if (!info) return;

  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = `chat-msg${isGold ? ' gold-quote' : ''}`;
  div.innerHTML = `
    <div class="msg-avatar ${info.avatarClass}">${info.emoji}</div>
    <div class="msg-body">
      <div class="msg-name ${info.nameClass}">${name} (${info.title})</div>
      <div class="msg-content">${escapeHtml(content)}</div>
    </div>
  `;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;

  // Update mood on participant chip
  const avatar = document.getElementById(`avatar-${role}`);
  if (avatar) {
    avatar.setAttribute('data-mood', mood || 'neutral');
  }
}

function showTypingIndicator(role) {
  const info = CHAR_INFO[role];
  if (!info) return null;

  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'typing-indicator';
  div.id = `typing-${role}`;
  div.innerHTML = `
    <div class="msg-avatar ${info.avatarClass}" style="width:28px;height:28px;font-size:14px">${info.emoji}</div>
    <div class="typing-dots"><span></span><span></span><span></span></div>
    <span class="typing-name">${info.name} æ­£åœ¨å‘è¨€...</span>
  `;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
  return div;
}

function removeTypingIndicator(role) {
  const el = document.getElementById(`typing-${role}`);
  if (el) el.remove();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==================== SEND MESSAGE ====================
async function sendMeetingMessage() {
  const input = document.getElementById('msgInput');
  const message = input.value.trim();
  if (!message || state.isSending) return;

  // Handle commands
  if (message === '/score') {
    input.value = '';
    showScoreCard();
    return;
  }
  if (message === '/exit') {
    input.value = '';
    endMeeting();
    return;
  }

  state.isSending = true;
  input.value = '';
  document.getElementById('meetingSendBtn').disabled = true;

  // Add user message
  addUserMessage(message);
  state.messages.push({ role: 'user', content: message });
  state.messageCount++;

  // Maybe trigger a random event
  if (Math.random() < 0.1) {
    const relevantEvents = MEETING_EVENTS.filter(
      e => !e.role || state.selectedRoles.includes(e.role)
    );
    if (relevantEvents.length > 0) {
      const event = relevantEvents[Math.floor(Math.random() * relevantEvents.length)];
      setTimeout(() => addSystemMessage(event.text), 500);
    }
  }

  try {
    // Build history for API (keep last 6 exchanges)
    const apiHistory = state.history.slice(-6);

    const response = await fetch('/api/meeting', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message,
        participants: state.selectedRoles,
        meetingType: state.meetingType,
        chaosLevel: state.chaosLevel,
        history: apiHistory,
        lastRespondents: state.lastRespondents,
      }),
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error || `è¯·æ±‚å¤±è´¥ (${response.status})`);
    }

    const data = await response.json();

    if (!data.responses || data.responses.length === 0) {
      throw new Error('æ²¡æœ‰è§’è‰²å›å¤');
    }

    // Add user message to history BEFORE AI responses (correct ordering)
    state.history.push({ role: 'user', content: message });

    // Display responses with staggered delays
    state.lastRespondents = data.responses.map(r => r.role);

    // Determine if any response is a "gold quote" (longest one)
    let longestIdx = 0;
    let longestLen = 0;
    data.responses.forEach((r, i) => {
      if (r.content.length > longestLen) {
        longestLen = r.content.length;
        longestIdx = i;
      }
    });
    const isGoldQuote = longestLen > 40 && data.responses.length >= 2;

    for (let i = 0; i < data.responses.length; i++) {
      const r = data.responses[i];

      // Show typing indicator first
      showTypingIndicator(r.role);

      // Staggered delay: 800ms + random 200-800ms per message
      await sleep(800 + Math.random() * 600);

      removeTypingIndicator(r.role);
      addRoleMessage(r.role, r.name, r.content, r.mood, isGoldQuote && i === longestIdx);

      // Track in state
      state.messages.push({ role: r.role, name: r.name, content: r.content, mood: r.mood });
      state.history.push({ role: 'assistant', content: `[${r.name}]: ${r.content}` });
    }

    // Cap arrays to prevent unbounded memory growth
    if (state.messages.length > 200) state.messages = state.messages.slice(-200);
    if (state.history.length > 20) state.history = state.history.slice(-20);

  } catch (err) {
    addSystemMessage(`âš ï¸ ${err.message || 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}`);
  }

  state.isSending = false;
  document.getElementById('meetingSendBtn').disabled = false;
  document.getElementById('msgInput').focus();
}

function handleMeetingKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMeetingMessage();
  }
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ==================== SCORE CARD ====================
function showScoreCard() {
  if (state.messages.length === 0) {
    addSystemMessage('è¿˜æ²¡æœ‰æ¶ˆæ¯è®°å½•ï¼Œå…ˆå‘å‡ æ¡æ¶ˆæ¯å†çœ‹è¯„åˆ†å§ï¼');
    return;
  }

  const card = generateScoreCard();
  const container = document.getElementById('scoreCardContent');

  const starStr = 'â˜…'.repeat(card.rating) + 'â˜†'.repeat(5 - card.rating);

  container.innerHTML = `
    <h3>ğŸ“Š ä¼šè®®è¯„åˆ†å¡</h3>
    <div class="score-row"><span class="score-label">æ€»æ¶ˆæ¯æ•°</span><span class="score-value">${card.totalMessages}</span></div>
    <div class="score-row"><span class="score-label">ç”»é¥¼æ¬¡æ•°</span><span class="score-value">${card.cakePaintCount}æ¬¡</span></div>
    <div class="score-row"><span class="score-label">é»‘è¯å¯†åº¦</span><span class="score-value">${card.jargonDensity}%</span></div>
    <div class="score-row"><span class="score-label">æœ‰æ•ˆå†³ç­–</span><span class="score-value">${card.effectiveDecisions}ä¸ª</span></div>
    <div class="score-row"><span class="score-label">æ‰“æ–­æ¬¡æ•°</span><span class="score-value">${card.interruptCount}æ¬¡</span></div>
    <div class="score-row"><span class="score-label">æœ€æ´»è·ƒ</span><span class="score-value">${escapeHtml(card.topContributor)}</span></div>
    <div class="score-stars">${starStr}</div>
    <div class="score-summary">"${escapeHtml(card.summary)}"</div>
    ${card.goldQuote ? `<div class="score-gold">ğŸ’ é‡‘å¥: ${escapeHtml(card.goldQuote)}</div>` : ''}
    <button class="score-close" onclick="closeScoreCard()">å…³é—­</button>
  `;

  document.getElementById('scoreOverlay').classList.add('active');
}

function closeScoreCard() {
  document.getElementById('scoreOverlay').classList.remove('active');
}

function generateScoreCard() {
  const CAKE_KW = ['æœŸæƒ','è‚¡æƒ','æœªæ¥','å‰æ™¯','å‘å±•ç©ºé—´','ä¸Šå¸‚','æ ¼å±€','èµ‹èƒ½','æŠ“æ‰‹','é—­ç¯','å¯¹é½','å¤§é¥¼','æ½œåŠ›','æœºä¼š','å¹³å°','æˆé•¿'];
  const JARGON_KW = ['èµ‹èƒ½','å¯¹é½','é—­ç¯','æŠ“æ‰‹','é¢—ç²’åº¦','æ‰“é€š','åº•å±‚é€»è¾‘','é¡¶å±‚è®¾è®¡','ç»„åˆæ‹³','æ–¹æ³•è®º','é“¾è·¯','æ¼æ–—','è§¦è¾¾','å¿ƒæ™º','æ‹‰é€š','æ²‰æ·€','å¤ç›˜','MVP','PMF','ROI','OKR','KPI'];

  const roleMsgs = {};
  let cakeCount = 0, jargonCount = 0, totalChars = 0, interruptCount = 0;
  let longestMsg = '', longestRole = '';

  for (const msg of state.messages) {
    if (msg.role === 'user') continue;
    roleMsgs[msg.role] = (roleMsgs[msg.role] || 0) + 1;
    totalChars += msg.content.length;

    for (const kw of CAKE_KW) { if (msg.content.includes(kw)) cakeCount++; }
    for (const kw of JARGON_KW) { if (msg.content.includes(kw)) jargonCount++; }
    if (msg.content.includes('ç­‰ç­‰') || msg.content.includes('æˆ‘è¯´') || msg.content.includes('æ‰“æ–­')) interruptCount++;

    if (msg.content.length > longestMsg.length) {
      longestMsg = msg.content;
      longestRole = msg.name || CHAR_INFO[msg.role]?.name || msg.role;
    }
  }

  let topRole = '', topCount = 0;
  for (const [role, count] of Object.entries(roleMsgs)) {
    if (count > topCount) { topCount = count; topRole = role; }
  }
  const topName = CHAR_INFO[topRole]?.name || topRole;

  const jargonDensity = totalChars > 0 ? Math.min(100, Math.round((jargonCount / (totalChars / 20)) * 100)) : 0;
  const totalMsgs = state.messages.filter(m => m.role !== 'user').length;
  const rating = Math.max(1, Math.min(5, 5 - Math.floor(cakeCount / 3) - Math.floor(interruptCount / 2)));

  const summaries = [
    'åˆä¸€åœºå¯ä»¥ç”¨é‚®ä»¶ä»£æ›¿çš„ä¼šè®®',
    'ä¼šè®®å¾ˆæˆåŠŸï¼Œä»€ä¹ˆéƒ½æ²¡å†³å®š',
    'æ—¶é—´ç®¡ç†å¤§å¸ˆä»¬çš„èšä¼š',
    'é»‘è¯æµ“åº¦è¶…æ ‡ï¼Œè¯·æ‰“å¼€çª—æˆ·',
    'æœ‰æ•ˆä¿¡æ¯å¯†åº¦çº¦ç­‰äºé›¶',
    'ä¸€åœºç²¾å½©çš„èŒåœºå¤§æˆ',
  ];

  return {
    totalMessages: totalMsgs,
    cakePaintCount: cakeCount,
    jargonDensity,
    effectiveDecisions: 0,
    interruptCount,
    topContributor: `${topName}(${topCount}æ¡)`,
    goldQuote: longestMsg ? `${longestRole}: "${longestMsg}"` : null,
    rating,
    summary: summaries[Math.floor(Math.random() * summaries.length)],
  };
}

// ==================== END MEETING ====================
function endMeeting() {
  showScoreCard();
}

// Close overlay on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeScoreCard();
});

// Close overlay on background click
document.getElementById('scoreOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeScoreCard();
});
</script>

</body>
</html>
